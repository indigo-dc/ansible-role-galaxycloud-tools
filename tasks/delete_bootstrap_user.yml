---
- include: start_postgres.yml
  become_user: root
  become_method: sudo

- name: Delete bootstrap user
  command: >
    chdir={{galaxy_install_path}} {{galaxy_venv_path}}/bin/python {{galaxy_custom_script_path}}/delete_galaxy_user.py
    --user {{bootstrap_user_mail}}
  environment:
    VIRTUAL_ENV: "{{ galaxy_venv_path }}"

- name: Remove bootstrap user as Galaxy Admin if admin_users tag was already in the config file
  replace: dest={{ galaxy_config_file }} regexp="admin_users = {{bootstrap_user_mail}}," replace="admin_users = "  #"
  register: admin_users_found

- name: Remove admin_users from galaxy.ini
  replace:
    dest: '{{galaxy_config_file}}'
    regexp: 'admin_users = {{bootstrap_user_mail}}'
    replace: '#admin_users = None'
  when: admin_users_found.msg == ""

- include: stop_postgres.yml
  become_user: root
  become_method: sudo
